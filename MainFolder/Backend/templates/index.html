<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisador de email</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        height: 100vh;
        display: grid;
        place-items: center;
      }
      .card {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
        width: 350px;
      }
      .row {
        margin: 10px 0;
        display: flex;
        flex-direction: column;
      }
      textarea {
        width: 100%;
        height: 80px;
      }
      .ok {
        color: #0a7b28;
      }
      .err {
        color: #b00020;
      }
      .hidden {
        display: none;
      }
      select {
        margin-bottom: 15px;
        padding: 5px;
      }
      pre {
        background: #eee;
        padding: 10px;
        white-space: pre-wrap;
      }
      .response-area {
        width: 100%;
        height: 200px; /* Altura fixa para simetria */
        margin: 15px 0;
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-family: monospace;
        resize: none; /* Remove redimensionamento para manter simetria */
        box-sizing: border-box;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }

      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .modal-buttons button {
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .confirm-btn {
        background: #28a745;
        color: white;
      }

      .cancel-btn {
        background: #dc3545;
        color: white;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .controls button {
        padding: 5px 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .controls button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Upload ou Texto</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="row">
          <label for="inputType">Selecione o tipo de entrada:</label>
          <select id="inputType" name="inputType">
            <option value="file">Arquivo</option>
            <option value="text">Texto</option>
          </select>
        </div>

        <div class="row" id="fileDiv">
          <label for="fileInput">Arquivo:</label>
          <input type="file" name="file" id="fileInput" accept=".txt,.pdf" />
        </div>

        <div class="row hidden" id="textDiv">
          <label for="textInput">Texto:</label>
          <textarea
            name="text"
            id="textInput"
            placeholder="Digite aqui..."
          ></textarea>
        </div>

        <div class="row">
          <button type="submit">Enviar</button>
        </div>
        <div class="row">
          <p id="status"></p>
          <textarea
            id="responseText"
            class="response-area"
            placeholder="A resposta aparecerá aqui..."
          ></textarea>
          <div class="controls">
            <button id="copyBtn" type="button">Copiar</button>
            <button id="saveBtn" type="button">Baixar resposta</button>
          </div>
        </div>
      </form>
    </div>

    <div id="downloadModal" class="modal">
      <div class="modal-content">
        <p>Deseja baixar a resposta?</p>
        <div class="modal-buttons">
          <button class="confirm-btn" id="confirmDownload">Confirmar</button>
          <button class="cancel-btn" id="cancelDownload">Cancelar</button>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("uploadForm");
      const statusText = document.getElementById("status");
      const responseText = document.getElementById("responseText");
      const inputType = document.getElementById("inputType");
      const fileDiv = document.getElementById("fileDiv");
      const textDiv = document.getElementById("textDiv");
      const fileInput = document.getElementById("fileInput");
      const textInput = document.getElementById("textInput");
      const copyBtn = document.getElementById("copyBtn");
      const saveBtn = document.getElementById("saveBtn");
      const downloadModal = document.getElementById("downloadModal");
      const confirmDownload = document.getElementById("confirmDownload");
      const cancelDownload = document.getElementById("cancelDownload");

      // Função para limpar todos os campos
      function limparCampos() {
        fileInput.value = "";
        textInput.value = "";
        statusText.textContent = "";
        statusText.className = "";
        responseText.value = "";
        inputType.value = "file";
        fileDiv.classList.remove("hidden");
        textDiv.classList.add("hidden");
      }

      // Limpa os campos quando a página carrega
      window.addEventListener("load", limparCampos);

      // Limpa os campos quando o usuário atualiza a página
      window.addEventListener("beforeunload", limparCampos);

      inputType.addEventListener("change", () => {
        if (inputType.value === "file") {
          fileDiv.classList.remove("hidden");
          textDiv.classList.add("hidden");
        } else {
          fileDiv.classList.add("hidden");
          textDiv.classList.remove("hidden");
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData();

        if (inputType.value === "file") {
          const file = document.getElementById("fileInput").files[0];
          if (!file) {
            statusText.textContent = "Selecione um arquivo!";
            statusText.className = "err";
            return;
          }
          formData.append("file", file);
        } else {
          const text = document.getElementById("textInput").value.trim();
          if (!text) {
            statusText.textContent = "Digite algum texto!";
            statusText.className = "err";
            return;
          }
          formData.append("text", text);
        }

        statusText.textContent = "Enviando...";
        responseText.value = "";

        try {
          const resp = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          const result = await resp.json();
          statusText.textContent = result.status;
          statusText.className = resp.ok ? "ok" : "err";
          if (result.response) {
            responseText.value = result.response;
          }
        } catch {
          statusText.textContent = "Erro no envio!";
          statusText.className = "err";
        }
      });

      // Função para copiar o texto para a área de transferência
      copyBtn.addEventListener("click", () => {
        responseText.select();
        document.execCommand("copy");
        statusText.textContent = "Texto copiado!";
        statusText.className = "ok";
        setTimeout(() => {
          statusText.textContent = "";
        }, 2000);
      });

      // Função para salvar o texto como arquivo
      function downloadFile() {
        const text = responseText.value;
        if (!text.trim()) {
          statusText.textContent = "Não há texto para baixar!";
          statusText.className = "err";
          setTimeout(() => {
            statusText.textContent = "";
          }, 2000);
          return;
        }

        const blob = new Blob([text], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "resposta.txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        statusText.textContent = "Arquivo salvo!";
        statusText.className = "ok";
        setTimeout(() => {
          statusText.textContent = "";
        }, 2000);
      }

      // Modificar o evento do botão salvar
      saveBtn.addEventListener("click", () => {
        if (!responseText.value.trim()) {
          statusText.textContent = "Não há texto para baixar!";
          statusText.className = "err";
          setTimeout(() => {
            statusText.textContent = "";
          }, 2000);
          return;
        }
        downloadModal.style.display = "block";
      });

      // Eventos do modal
      confirmDownload.addEventListener("click", () => {
        downloadModal.style.display = "none";
        downloadFile();
      });

      cancelDownload.addEventListener("click", () => {
        downloadModal.style.display = "none";
      });

      // Fechar modal ao clicar fora
      window.addEventListener("click", (e) => {
        if (e.target === downloadModal) {
          downloadModal.style.display = "none";
        }
      });
    </script>
  </body>
</html>
